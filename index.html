<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>단항식과 다항식의 계산 빈출(2)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f2f2f2;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
    }
    .container {
      max-width: 800px;
      width: 100%;
      background-color: #fff;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      text-align: center;
    }
    h1 {
      margin-bottom: 20px;
    }
    #startScreen, #gameScreen, #resultScreen {
      display: none;
    }
    input[type="text"] {
      padding: 10px;
      font-size: 16px;
      width: 200px;
      margin: 10px 0;
    }
    select {
      padding: 10px;
      font-size: 16px;
      margin: 10px 0;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      margin: 5px;
    }
    .choice-container {
      margin: 20px 0;
    }
    .choice-button {
      display: inline-block;
      padding: 10px 15px;
      margin: 0 5px;
      background-color: #e0e0e0;
      border: none;
      cursor: pointer;
      font-size: 16px;
    }
    .choice-button:hover {
      background-color: #ccc;
    }
    img.problem-image {
      max-width: 100%;
      height: auto;
      margin: 20px 0;
    }
    #gameInfo span {
      font-size: 18px;
      margin: 0 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>단항식과 다항식의 계산 빈출(2)</h1>
    
    <!-- 시작화면 -->
    <div id="startScreen">
      <input type="text" id="playerName" placeholder="이름을 입력하세요"><br>
      <select id="difficulty">
        <option value="최상">최상 (20초)</option>
        <option value="상">상 (30초)</option>
        <option value="중">중 (40초)</option>
        <option value="하">하 (시간제한없음)</option>
      </select><br>
      <button id="startGameBtn">게임시작</button>
    </div>
    
    <!-- 게임 진행 화면 -->
    <div id="gameScreen">
      <div id="gameInfo">
        <span id="elapsedTime">경과시간: 0초</span>
        <span id="lives">남은 기회: 3</span>
        <span id="score">점수: 0</span>
        <span id="questionTimer"></span>
      </div>
      
      <div id="problemContainer">
        <!-- 문제 이미지가 표시됩니다 -->
      </div>
      
      <div id="answerContainer">
        <!-- 문제 유형에 따라 객관식 버튼 또는 주관식 입력란과 확인버튼이 생성됩니다 -->
      </div>
      
      <div id="feedback"></div>
      
      <button id="nextQuestionBtn" style="display:none;">다음문제</button>
    </div>
    
    <!-- 게임 종료 후 결과 화면 -->
    <div id="resultScreen">
      <h2>게임 종료</h2>
      <p id="finalTime"></p>
      <p id="finalScore"></p>
      <div id="resultButtons">
        <!-- 조기탈락 시 '다시하기'와 정상 종료 시 '전송하기' 버튼이 생성됩니다 -->
      </div>
      <div id="response"></div>
    </div>
  </div>
  
  <script>
    // 문제 데이터 배열 – 모든 이미지와 정답, 문제 유형을 포함합니다.
    const problems = [
      { image: "https://github.com/dr-youngjin/image-file/blob/main/%EB%8B%A4%ED%95%AD%EC%8B%9D/%EB%AC%B81.png?raw=true", answer: "3", type: "객관식" },
      { image: "https://github.com/dr-youngjin/image-file/blob/main/%EB%8B%A4%ED%95%AD%EC%8B%9D/%EB%AC%B82.png?raw=true", answer: "3", type: "객관식" },
      { image: "https://github.com/dr-youngjin/image-file/blob/main/%EB%8B%A4%ED%95%AD%EC%8B%9D/%EB%AC%B83.png?raw=true", answer: "1", type: "객관식" },
      { image: "https://github.com/dr-youngjin/image-file/blob/main/%EB%8B%A4%ED%95%AD%EC%8B%9D/%EB%AC%B85.png?raw=true", answer: "1", type: "객관식" },
      { image: "https://github.com/dr-youngjin/image-file/blob/main/%EB%8B%A4%ED%95%AD%EC%8B%9D/%EB%AC%B86.png?raw=true", answer: "7", type: "주관식" },
      { image: "https://github.com/dr-youngjin/image-file/blob/main/%EB%8B%A4%ED%95%AD%EC%8B%9D/%EB%AC%B87.png?raw=true", answer: "3", type: "객관식" },
      { image: "https://github.com/dr-youngjin/image-file/blob/main/%EB%8B%A4%ED%95%AD%EC%8B%9D/%EB%AC%B88.png?raw=true", answer: "2", type: "객관식" },
      { image: "https://github.com/dr-youngjin/image-file/blob/main/%EB%8B%A4%ED%95%AD%EC%8B%9D/%EB%AC%B89.png?raw=true", answer: "4", type: "객관식" },
      { image: "https://github.com/dr-youngjin/image-file/blob/main/%EB%8B%A4%ED%95%AD%EC%8B%9D/%EB%AC%B810.png?raw=true", answer: "3", type: "객관식" },
      { image: "https://github.com/dr-youngjin/image-file/blob/main/%EB%8B%A4%ED%95%AD%EC%8B%9D/%EB%AC%B811.png?raw=true", answer: "3", type: "객관식" },
      { image: "https://github.com/dr-youngjin/image-file/blob/main/%EB%8B%A4%ED%95%AD%EC%8B%9D/%EB%AC%B812.png?raw=true", answer: "4", type: "객관식" },
      { image: "https://github.com/dr-youngjin/image-file/blob/main/%EB%8B%A4%ED%95%AD%EC%8B%9D/%EB%AC%B813.png?raw=true", answer: "3", type: "객관식" },
      { image: "https://github.com/dr-youngjin/image-file/blob/main/%EB%8B%A4%ED%95%AD%EC%8B%9D/%EB%AC%B814.png?raw=true", answer: "3", type: "객관식" },
      { image: "https://github.com/dr-youngjin/image-file/blob/main/%EB%8B%A4%ED%95%AD%EC%8B%9D/%EB%AC%B815.png?raw=true", answer: "5", type: "객관식" },
      { image: "https://github.com/dr-youngjin/image-file/blob/main/%EB%8B%A4%ED%95%AD%EC%8B%9D/%EB%AC%B816.png?raw=true", answer: "2", type: "객관식" },
      { image: "https://github.com/dr-youngjin/image-file/blob/main/%EB%8B%A4%ED%95%AD%EC%8B%9D/%EB%AC%B817.png?raw=true", answer: "5", type: "객관식" },
      { image: "https://github.com/dr-youngjin/image-file/blob/main/%EB%8B%A4%ED%95%AD%EC%8B%9D/%EB%AC%B819.png?raw=true", answer: "4", type: "객관식" },
      { image: "https://github.com/dr-youngjin/image-file/blob/main/%EB%8B%A4%ED%95%AD%EC%8B%9D/%EB%AC%B820.png?raw=true", answer: "6", type: "주관식" },
      { image: "https://github.com/dr-youngjin/image-file/blob/main/%EB%8B%A4%ED%95%AD%EC%8B%9D/%EB%AC%B821.png?raw=true", answer: "5", type: "객관식" },
      { image: "https://github.com/dr-youngjin/image-file/blob/main/%EB%8B%A4%ED%95%AD%EC%8B%9D/%EB%AC%B822.png?raw=true", answer: "5", type: "객관식" },
      { image: "https://github.com/dr-youngjin/image-file/blob/main/%EB%8B%A4%ED%95%AD%EC%8B%9D/%EB%AC%B823.png?raw=true", answer: "1", type: "객관식" },
      { image: "https://github.com/dr-youngjin/image-file/blob/main/%EB%8B%A4%ED%95%AD%EC%8B%9D/%EB%AC%B824.png?raw=true", answer: "2", type: "객관식" },
      { image: "https://github.com/dr-youngjin/image-file/blob/main/%EB%8B%A4%ED%95%AD%EC%8B%9D/%EB%AC%B826.png?raw=true", answer: "1", type: "객관식" },
      { image: "https://github.com/dr-youngjin/image-file/blob/main/%EB%8B%A4%ED%95%AD%EC%8B%9D/%EB%AC%B827.png?raw=true", answer: "1", type: "객관식" },
      { image: "https://github.com/dr-youngjin/image-file/blob/main/%EB%8B%A4%ED%95%AD%EC%8B%9D/%EB%AC%B828.png?raw=true", answer: "1", type: "객관식" },
      { image: "https://github.com/dr-youngjin/image-file/blob/main/%EB%8B%A4%ED%95%AD%EC%8B%9D/%EB%AC%B829.png?raw=true", answer: "5", type: "객관식" }
    ];
    
    let currentProblemIndex = 0;
    let score = 0;
    let lives = 3;
    let gameStarted = false;
    let elapsedTime = 0;
    let gameTimerInterval;
    let questionTimerInterval;
    let currentQuestionTime;
    let currentQuestionTimeLimit = 0; // 문제당 제한시간(초)
    let difficulty = "";
    
    // 난이도별 정답 시 획득 점수
    const scorePerDifficulty = {
      "최상": 20,
      "상": 15,
      "중": 13,
      "하": 10
    };
    
    // 난이도별 문제 제한시간 (하: 제한없음 → 0)
    const timeLimitPerDifficulty = {
      "최상": 20,
      "상": 30,
      "중": 40,
      "하": 0
    };
    
    // 시작화면 표시
    document.getElementById('startScreen').style.display = "block";
    
    document.getElementById('startGameBtn').addEventListener('click', startGame);
    
    function startGame() {
      const name = document.getElementById('playerName').value.trim();
      if(name === "") {
        alert("이름을 입력해주세요.");
        return;
      }
      difficulty = document.getElementById('difficulty').value;
      currentQuestionTimeLimit = timeLimitPerDifficulty[difficulty];
      
      document.getElementById('startScreen').style.display = "none";
      document.getElementById('gameScreen').style.display = "block";
      
      gameStarted = true;
      currentProblemIndex = 0;
      score = 0;
      lives = 3;
      elapsedTime = 0;
      
      updateGameInfo();
      startElapsedTimer();
      loadProblem();
    }
    
    // 전체 경과시간 타이머 (1초마다 증가)
    function startElapsedTimer() {
      gameTimerInterval = setInterval(() => {
        elapsedTime++;
        document.getElementById('elapsedTime').innerText = "경과시간: " + elapsedTime + "초";
      }, 1000);
    }
    
    // 문제 제한시간 타이머 (난이도 하 제외)
    function startQuestionTimer() {
      if(currentQuestionTimeLimit > 0) {
        currentQuestionTime = currentQuestionTimeLimit;
        document.getElementById('questionTimer').innerText = "제한시간: " + currentQuestionTime + "초";
        questionTimerInterval = setInterval(() => {
          currentQuestionTime--;
          document.getElementById('questionTimer').innerText = "제한시간: " + currentQuestionTime + "초";
          if(currentQuestionTime <= 0) {
            clearInterval(questionTimerInterval);
            showFeedback("시간초과! 정답은: " + problems[currentProblemIndex].answer);
            disableAnswerInputs();
            document.getElementById('nextQuestionBtn').style.display = "block";
          }
        }, 1000);
      } else {
        document.getElementById('questionTimer').innerText = "";
      }
    }
    
    // 현재 문제 로드 – 이미지, 답안 입력방식 생성
    function loadProblem() {
      // 이전 피드백 및 입력창 초기화
      document.getElementById('feedback').innerText = "";
      document.getElementById('answerContainer').innerHTML = "";
      document.getElementById('nextQuestionBtn').style.display = "none";
      
      if(currentProblemIndex >= problems.length) {
        endGame();
        return;
      }
      
      const problem = problems[currentProblemIndex];
      
      // 문제 이미지 표시 (이미지 크기는 CSS로 조절)
      document.getElementById('problemContainer').innerHTML = 
        '<img class="problem-image" src="' + problem.image + '" alt="문제 이미지">';
      
      if(problem.type === "객관식") {
        // 객관식: 1~5번 버튼 생성 (각 버튼 간 간격 존재)
        const container = document.createElement('div');
        container.className = "choice-container";
        for(let i = 1; i <= 5; i++) {
          const btn = document.createElement('button');
          btn.className = "choice-button";
          btn.innerText = i;
          btn.addEventListener('click', () => submitAnswer(String(i)));
          container.appendChild(btn);
        }
        document.getElementById('answerContainer').appendChild(container);
      } else if(problem.type === "주관식") {
        // 주관식: 입력란과 '확인' 버튼 생성
        const input = document.createElement('input');
        input.type = "text";
        input.id = "subjectiveAnswer";
        input.placeholder = "정답을 입력하세요";
        const confirmBtn = document.createElement('button');
        confirmBtn.innerText = "확인";
        confirmBtn.addEventListener('click', () => {
          const userAnswer = document.getElementById('subjectiveAnswer').value.trim();
          submitAnswer(userAnswer);
        });
        document.getElementById('answerContainer').appendChild(input);
        document.getElementById('answerContainer').appendChild(confirmBtn);
      }
      
      // 문제 제한시간 타이머 시작 (해당 난이도에 한함)
      startQuestionTimer();
    }
    
    // 답안 제출 후 버튼 및 입력란 비활성화
    function disableAnswerInputs() {
      const buttons = document.querySelectorAll('#answerContainer button');
      buttons.forEach(btn => btn.disabled = true);
      const input = document.querySelector('#answerContainer input');
      if(input) {
        input.disabled = true;
      }
    }
    
    // 답안 확인 및 처리 (정답/오답에 따른 점수, 기회 업데이트)
    function submitAnswer(answer) {
      if(questionTimerInterval) {
        clearInterval(questionTimerInterval);
      }
      
      const problem = problems[currentProblemIndex];
      if(answer === problem.answer) {
        score += scorePerDifficulty[difficulty];
        updateGameInfo();
        showFeedback("정답입니다!");
        disableAnswerInputs();
        document.getElementById('nextQuestionBtn').style.display = "block";
      } else {
        lives--;
        updateGameInfo();
        showFeedback("오답입니다! 정답은: " + problem.answer);
        disableAnswerInputs();
        document.getElementById('nextQuestionBtn').style.display = "block";
        if(lives <= 0) {
          endGame();
        }
      }
    }
    
    // 점수 및 남은 기회 갱신
    function updateGameInfo() {
      document.getElementById('score').innerText = "점수: " + score;
      document.getElementById('lives').innerText = "남은 기회: " + lives;
    }
    
    // 피드백 메시지 출력
    function showFeedback(message) {
      document.getElementById('feedback').innerText = message;
    }
    
    // "다음문제" 버튼 클릭 시 다음 문제 로드
    document.getElementById('nextQuestionBtn').addEventListener('click', () => {
      currentProblemIndex++;
      loadProblem();
    });
    
    // 게임 종료 처리 – 타이머 정지 후 결과 화면 표시
    function endGame() {
      clearInterval(gameTimerInterval);
      clearInterval(questionTimerInterval);
      document.getElementById('gameScreen').style.display = "none";
      document.getElementById('resultScreen').style.display = "block";
      document.getElementById('finalTime').innerText = "경과시간: " + elapsedTime + "초";
      document.getElementById('finalScore').innerText = "점수: " + score;
      
      const resultButtons = document.getElementById('resultButtons');
      resultButtons.innerHTML = "";
      
      // 문제를 모두 다 풀지 않고 3회 오답일 경우 '다시하기' 버튼 표시
      if(currentProblemIndex < problems.length) {
        const retryBtn = document.createElement('button');
        retryBtn.innerText = "다시하기";
        retryBtn.addEventListener('click', () => {
          location.reload();
        });
        resultButtons.appendChild(retryBtn);
      }
      
      // 항상 '전송하기' 버튼 생성
      const sendBtn = document.createElement('button');
      sendBtn.innerText = "전송하기";
      sendBtn.addEventListener('click', sendData);
      resultButtons.appendChild(sendBtn);
    }
    
    // 서버 전송을 위한 데이터 구성 및 saveData 호출
    function sendData() {
      const name = document.getElementById('playerName').value.trim();
      const gameTitle = "단항식과 다항식의 계산 빈출(2)";
      saveData(gameTitle, name, score, elapsedTime);
    }
    
    // 서버로 데이터를 전송하는 함수 (제공된 코드 적용)
    function saveData(game, name, score, elapsedTime) {
        const FUNCTION_URL = "https://us-central1-record-f420d.cloudfunctions.net/report";

        const requestData = {
            game,
            name,
            score: parseInt(score, 10),
            elapsedTime: parseInt(elapsedTime, 10)
        };

        fetch(FUNCTION_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json().then(data => ({status: response.status, ok: response.ok, data})))
            .then(result => {
                if (result.ok) {
                    document.getElementById('response').innerText = 
                        "성공: " + JSON.stringify(result.data, null, 2);
                } else {
                    document.getElementById('response').innerText = 
                        "오류: " + JSON.stringify(result.data, null, 2);
                }
            })
            .catch(error => {
                console.error('요청 실패:', error);
                document.getElementById('response').innerText = 
                    "네트워크 오류: " + error.message;
            });
    }
  </script>
</body>
</html>
